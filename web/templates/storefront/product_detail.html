{{define "title"}}{{.Product.Name}}{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl">
    <!-- Breadcrumb -->
    <nav class="mb-8 flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/products" class="text-sm font-medium text-zinc-500 hover:text-zinc-950 dark:text-zinc-400 dark:hover:text-white">
                    Products
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <span class="mx-2 text-zinc-400">/</span>
                    <span class="text-sm font-medium text-zinc-950 dark:text-white">{{.Product.Name}}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid gap-8 lg:grid-cols-2">
        <!-- Product Image -->
        <div class="rounded-2xl bg-zinc-100 dark:bg-zinc-800 aspect-square flex items-center justify-center">
            {{if .Images}}
                <img src="{{index .Images 0}}" alt="{{.Product.Name}}" class="h-full w-full object-cover rounded-2xl">
            {{else}}
                <div class="text-center">
                    <svg class="mx-auto h-24 w-24 text-zinc-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-2 text-sm text-zinc-500 dark:text-zinc-400">No image available</p>
                </div>
            {{end}}
        </div>

        <!-- Product Info -->
        <div class="flex flex-col">
            <!-- Product Name & Origin -->
            <div>
                {{template "heading" (dict "Level" "1" "Content" .Product.Name)}}
                {{if .Product.Origin.Valid}}
                <p class="mt-2 text-lg text-zinc-600 dark:text-zinc-400">{{.Product.Origin.String}}</p>
                {{end}}
            </div>

            <!-- Short Description -->
            {{if .Product.ShortDescription.Valid}}
            <p class="mt-4 text-base/7 text-zinc-700 dark:text-zinc-300">
                {{.Product.ShortDescription.String}}
            </p>
            {{end}}

            <!-- SKU Selection Form -->
            <form id="add-to-cart-form" action="/cart/add" method="POST"
                  class="mt-8 space-y-6"
                  x-data="{
                      selectedWeight: '{{if .Weights}}{{index .Weights 0}}{{end}}',
                      selectedGrind: '{{if .Grinds}}{{index .Grinds 0}}{{end}}',
                      selectedSKU: null,
                      price: 0,
                      quantity: 1,
                      skus: [
                          {{range $i, $sku := .SKUs}}{{if $i}},{{end}}{
                              'id': '{{$sku.SKU.ID}}',
                              'weight': '{{formatWeight $sku.SKU.WeightValue}}{{$sku.SKU.WeightUnit}}',
                              'grind': '{{$sku.SKU.Grind}}',
                              'price': {{$sku.PriceCents}}
                          }{{end}}
                      ],
                      findMatchingSKU() {
                          const match = this.skus.find(s =>
                              s.weight === this.selectedWeight && s.grind === this.selectedGrind
                          );
                          if (match) {
                              this.selectedSKU = match.id;
                              this.price = match.price / 100;
                          }
                      }
                  }"
                  x-init="findMatchingSKU()"
                  @change="findMatchingSKU()">

                <!-- Weight Selection -->
                {{if .Weights}}
                <div>
                    {{template "field" (dict
                        "Label" "Size"
                        "Required" true
                        "Select" (dict
                            "ID" "weight"
                            "Name" "weight"
                            "Required" true
                            "XModel" "selectedWeight"
                            "Options" (list)))}}
                    <select id="weight" name="weight" required x-model="selectedWeight"
                            class="block w-full rounded-lg border-zinc-950/10 py-[calc(theme(spacing[2.5])-1px)] px-[calc(theme(spacing[3.5])-1px)] text-base/6 sm:text-sm/6 dark:border-white/10 dark:bg-white/5 dark:[color-scheme:dark]">
                        {{range .Weights}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <!-- Grind Selection -->
                {{if .Grinds}}
                <div>
                    {{template "field" (dict
                        "Label" "Grind"
                        "Required" true
                        "Select" (dict
                            "ID" "grind"
                            "Name" "grind"
                            "Required" true
                            "XModel" "selectedGrind"
                            "Options" (list)))}}
                    <select id="grind" name="grind" required x-model="selectedGrind"
                            class="block w-full rounded-lg border-zinc-950/10 py-[calc(theme(spacing[2.5])-1px)] px-[calc(theme(spacing[3.5])-1px)] text-base/6 sm:text-sm/6 capitalize dark:border-white/10 dark:bg-white/5 dark:[color-scheme:dark]">
                        {{range .Grinds}}
                        <option value="{{.}}" class="capitalize">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <!-- Quantity -->
                <div>
                    {{template "field" (dict
                        "Label" "Quantity"
                        "Required" true
                        "Input" (dict
                            "Type" "number"
                            "ID" "quantity"
                            "Name" "quantity"
                            "Required" true
                            "Value" 1
                            "Min" 1
                            "XModel" "quantity"))}}
                    <input type="number" id="quantity" name="quantity" required x-model="quantity" min="1" value="1"
                           class="block w-full rounded-lg border-zinc-950/10 py-[calc(theme(spacing[2.5])-1px)] px-[calc(theme(spacing[3.5])-1px)] text-base/6 sm:text-sm/6 dark:border-white/10 dark:bg-white/5 dark:[color-scheme:dark]">
                </div>

                <!-- Hidden SKU ID -->
                <input type="hidden" name="sku_id" x-model="selectedSKU">

                <!-- Price Display -->
                <div class="rounded-lg bg-zinc-50 p-4 ring-1 ring-zinc-950/5 dark:bg-zinc-900/50 dark:ring-white/10">
                    <div class="flex items-baseline justify-between">
                        <span class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Price</span>
                        <span class="text-3xl font-bold text-zinc-950 dark:text-white" x-text="'$' + price.toFixed(2)">$0.00</span>
                    </div>
                    <div class="mt-2 flex items-baseline justify-between text-sm">
                        <span class="text-zinc-500 dark:text-zinc-400">Total</span>
                        <span class="font-semibold text-zinc-700 dark:text-zinc-300" x-text="'$' + (price * quantity).toFixed(2)">$0.00</span>
                    </div>
                </div>

                <!-- Add to Cart Button -->
                {{template "button" (dict
                    "Content" "Add to Cart"
                    "Type" "submit"
                    "Variant" "solid"
                    "Color" "zinc"
                    "Class" "w-full")}}
            </form>

            <!-- Coffee Attributes -->
            {{if or .Product.RoastLevel.Valid .Product.Process.Valid .Product.TastingNotes}}
            <div class="mt-12 space-y-6">
                <h3 class="text-lg font-semibold text-zinc-950 dark:text-white">Details</h3>

                <dl class="space-y-4">
                    {{if .Product.RoastLevel.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Roast Level</dt>
                        <dd class="text-sm text-zinc-950 dark:text-white capitalize">{{.Product.RoastLevel.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Process.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Process</dt>
                        <dd class="text-sm text-zinc-950 dark:text-white capitalize">{{.Product.Process.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Region.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Region</dt>
                        <dd class="text-sm text-zinc-950 dark:text-white">{{.Product.Region.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Producer.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Producer</dt>
                        <dd class="text-sm text-zinc-950 dark:text-white">{{.Product.Producer.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.TastingNotes}}
                    <div>
                        <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400 mb-2">Tasting Notes</dt>
                        <dd class="flex flex-wrap gap-2">
                            {{range .Product.TastingNotes}}
                                {{template "badge" (dict "Content" . "Color" "blue")}}
                            {{end}}
                        </dd>
                    </div>
                    {{end}}
                </dl>
            </div>
            {{end}}

            <!-- Full Description -->
            {{if .Product.Description.Valid}}
            <div class="mt-12">
                <h3 class="text-lg font-semibold text-zinc-950 dark:text-white mb-4">About This Coffee</h3>
                <div class="prose prose-zinc dark:prose-invert max-w-none">
                    <p class="text-base/7 text-zinc-700 dark:text-zinc-300 whitespace-pre-wrap">{{.Product.Description.String}}</p>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
// Handle form submission with HTMX or standard form
document.getElementById('add-to-cart-form')?.addEventListener('submit', function(e) {
    const skuId = this.querySelector('[name="sku_id"]').value;
    if (!skuId) {
        e.preventDefault();
        alert('Please select a size and grind option');
    }
});
</script>
{{end}}
