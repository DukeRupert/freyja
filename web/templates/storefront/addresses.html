{{define "title"}}Saved Addresses{{end}}

{{define "content"}}
<div class="mx-auto max-w-4xl px-4 py-8 sm:px-6 lg:px-8" x-data="addressManager()">
    <!-- Page Header -->
    <div class="mb-8">
        <div class="flex items-center gap-2 text-sm text-neutral-500 mb-4">
            <a href="/account" class="hover:text-teal-700">My Account</a>
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
            </svg>
            <span class="text-neutral-900">Addresses</span>
        </div>
        <div class="flex items-center justify-between">
            {{template "sf-heading" (dict "Level" "1" "Content" "Saved Addresses")}}
            <button @click="openAddModal()"
                    class="inline-flex items-center gap-2 rounded-lg bg-teal-700 px-4 py-2 text-sm font-medium text-white hover:bg-teal-800 transition-colors">
                <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
                </svg>
                Add Address
            </button>
        </div>
        <p class="mt-2 text-base text-neutral-600">
            Manage your shipping and billing addresses
        </p>
    </div>

    <!-- Addresses Grid -->
    {{if .Addresses}}
    <div class="grid gap-6 sm:grid-cols-2">
        {{range .Addresses}}
        <div class="rounded-lg bg-white border border-neutral-200 shadow-sm p-6 relative">
            <!-- Default Badges -->
            <div class="flex flex-wrap gap-2 mb-4">
                {{if .IsDefaultShipping}}
                <span class="inline-flex items-center rounded-full bg-teal-100 px-2.5 py-0.5 text-xs font-medium text-teal-800">
                    Default Shipping
                </span>
                {{end}}
                {{if .IsDefaultBilling}}
                <span class="inline-flex items-center rounded-full bg-amber-100 px-2.5 py-0.5 text-xs font-medium text-amber-800">
                    Default Billing
                </span>
                {{end}}
            </div>

            <!-- Label -->
            <h3 class="text-lg font-semibold text-neutral-900 mb-2">{{.Label}}</h3>

            <!-- Address Details -->
            <div class="text-sm text-neutral-600 space-y-1">
                <p class="font-medium text-neutral-900">{{.FullName}}</p>
                {{if .Company}}
                <p>{{.Company}}</p>
                {{end}}
                <p>{{.AddressLine1}}</p>
                {{if .AddressLine2}}
                <p>{{.AddressLine2}}</p>
                {{end}}
                <p>{{.City}}, {{.State}} {{.PostalCode}}</p>
                {{if and .Country (ne .Country "US")}}
                <p>{{.Country}}</p>
                {{end}}
                {{if .Phone}}
                <p class="mt-2">{{.Phone}}</p>
                {{end}}
            </div>

            <!-- Actions -->
            <div class="mt-4 pt-4 border-t border-neutral-100 flex items-center gap-3">
                <button @click="openEditModal('{{.ID}}')"
                        class="text-sm font-medium text-teal-700 hover:text-teal-800 transition-colors">
                    Edit
                </button>
                {{if not .IsDefaultShipping}}
                <form action="/account/addresses/{{.ID}}/default" method="POST" class="inline">
                    {{$.CSRFField}}
                    <button type="submit"
                            class="text-sm font-medium text-neutral-600 hover:text-neutral-800 transition-colors">
                        Set as Default
                    </button>
                </form>
                {{end}}
                <form action="/account/addresses/{{.ID}}/delete" method="POST" class="inline ml-auto"
                      onsubmit="return confirm('Delete this address?')">
                    {{$.CSRFField}}
                    <button type="submit"
                            class="text-sm font-medium text-red-600 hover:text-red-700 transition-colors">
                        Delete
                    </button>
                </form>
            </div>
        </div>
        {{end}}
    </div>
    {{else}}
    <!-- Empty State -->
    {{template "sf-empty-state" (dict
        "Icon" "<path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z\"/><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 11a3 3 0 11-6 0 3 3 0 016 0z\"/>"
        "Title" "No saved addresses"
        "Description" "Add an address to save time at checkout")}}

    <div class="mt-8 text-center">
        <button @click="openAddModal()"
                class="inline-flex items-center gap-2 rounded-lg bg-teal-700 px-6 py-3 text-sm font-medium text-white hover:bg-teal-800 transition-colors">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" />
            </svg>
            Add Your First Address
        </button>
    </div>
    {{end}}

    <!-- Add/Edit Address Modal -->
    <div x-show="showModal"
         x-cloak
         class="fixed inset-0 z-50 overflow-y-auto"
         aria-labelledby="modal-title"
         role="dialog"
         aria-modal="true">
        <div class="flex min-h-full items-end justify-center p-4 text-center sm:items-center sm:p-0">
            <!-- Backdrop -->
            <div x-show="showModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0"
                 x-transition:enter-end="opacity-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100"
                 x-transition:leave-end="opacity-0"
                 @click="closeModal()"
                 class="fixed inset-0 bg-neutral-900/50 transition-opacity"></div>

            <!-- Modal Panel -->
            <div x-show="showModal"
                 x-transition:enter="ease-out duration-300"
                 x-transition:enter-start="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 x-transition:enter-end="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave="ease-in duration-200"
                 x-transition:leave-start="opacity-100 translate-y-0 sm:scale-100"
                 x-transition:leave-end="opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95"
                 class="relative transform overflow-hidden rounded-lg bg-white text-left shadow-xl transition-all sm:my-8 sm:w-full sm:max-w-lg">
                <form :action="formAction" method="POST" class="p-6">
                    {{.CSRFField}}

                    <div class="flex items-center justify-between mb-6">
                        <h2 class="text-xl font-semibold text-neutral-900" x-text="isEditing ? 'Edit Address' : 'Add Address'"></h2>
                        <button type="button" @click="closeModal()" class="text-neutral-400 hover:text-neutral-500">
                            <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                            </svg>
                        </button>
                    </div>

                    <div id="error-message" class="mb-4"></div>

                    <div class="space-y-4">
                        <!-- Label -->
                        <div>
                            <label for="label" class="block text-sm font-medium text-neutral-700 mb-1">
                                Label
                            </label>
                            <input type="text"
                                   id="label"
                                   name="label"
                                   x-model="form.label"
                                   placeholder="e.g., Home, Office, Warehouse"
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- Full Name -->
                        <div>
                            <label for="full_name" class="block text-sm font-medium text-neutral-700 mb-1">
                                Full Name <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   id="full_name"
                                   name="full_name"
                                   x-model="form.full_name"
                                   required
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- Company -->
                        <div>
                            <label for="company" class="block text-sm font-medium text-neutral-700 mb-1">
                                Company
                            </label>
                            <input type="text"
                                   id="company"
                                   name="company"
                                   x-model="form.company"
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- Address Line 1 -->
                        <div>
                            <label for="address_line1" class="block text-sm font-medium text-neutral-700 mb-1">
                                Address <span class="text-red-500">*</span>
                            </label>
                            <input type="text"
                                   id="address_line1"
                                   name="address_line1"
                                   x-model="form.address_line1"
                                   required
                                   placeholder="Street address"
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- Address Line 2 -->
                        <div>
                            <input type="text"
                                   id="address_line2"
                                   name="address_line2"
                                   x-model="form.address_line2"
                                   placeholder="Apartment, suite, etc. (optional)"
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- City, State, ZIP -->
                        <div class="grid grid-cols-6 gap-4">
                            <div class="col-span-3">
                                <label for="city" class="block text-sm font-medium text-neutral-700 mb-1">
                                    City <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="city"
                                       name="city"
                                       x-model="form.city"
                                       required
                                       class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                            </div>
                            <div class="col-span-1">
                                <label for="state" class="block text-sm font-medium text-neutral-700 mb-1">
                                    State <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="state"
                                       name="state"
                                       x-model="form.state"
                                       required
                                       maxlength="2"
                                       placeholder="CA"
                                       class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                            </div>
                            <div class="col-span-2">
                                <label for="postal_code" class="block text-sm font-medium text-neutral-700 mb-1">
                                    ZIP <span class="text-red-500">*</span>
                                </label>
                                <input type="text"
                                       id="postal_code"
                                       name="postal_code"
                                       x-model="form.postal_code"
                                       required
                                       class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                            </div>
                        </div>

                        <!-- Country -->
                        <div>
                            <label for="country" class="block text-sm font-medium text-neutral-700 mb-1">
                                Country
                            </label>
                            <select id="country"
                                    name="country"
                                    x-model="form.country"
                                    class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                                <option value="US">United States</option>
                                <option value="CA">Canada</option>
                            </select>
                        </div>

                        <!-- Phone -->
                        <div>
                            <label for="phone" class="block text-sm font-medium text-neutral-700 mb-1">
                                Phone
                            </label>
                            <input type="tel"
                                   id="phone"
                                   name="phone"
                                   x-model="form.phone"
                                   class="w-full rounded-lg border border-neutral-300 px-4 py-2 text-sm focus:border-teal-500 focus:ring-1 focus:ring-teal-500">
                        </div>

                        <!-- Default Shipping Checkbox -->
                        <div class="flex items-center gap-2">
                            <input type="checkbox"
                                   id="is_default_shipping"
                                   name="is_default_shipping"
                                   x-model="form.is_default_shipping"
                                   class="h-4 w-4 rounded border-neutral-300 text-teal-600 focus:ring-teal-500">
                            <label for="is_default_shipping" class="text-sm text-neutral-700">
                                Set as default shipping address
                            </label>
                        </div>
                    </div>

                    <!-- Actions -->
                    <div class="mt-6 flex justify-end gap-3">
                        <button type="button"
                                @click="closeModal()"
                                class="rounded-lg border border-neutral-300 bg-white px-4 py-2 text-sm font-medium text-neutral-700 hover:bg-neutral-50 transition-colors">
                            Cancel
                        </button>
                        <button type="submit"
                                class="rounded-lg bg-teal-700 px-4 py-2 text-sm font-medium text-white hover:bg-teal-800 transition-colors">
                            <span x-text="isEditing ? 'Save Changes' : 'Add Address'"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
function addressManager() {
    return {
        showModal: false,
        isEditing: false,
        editingId: null,
        form: {
            label: '',
            full_name: '',
            company: '',
            address_line1: '',
            address_line2: '',
            city: '',
            state: '',
            postal_code: '',
            country: 'US',
            phone: '',
            is_default_shipping: false
        },

        get formAction() {
            return this.isEditing ? `/account/addresses/${this.editingId}` : '/account/addresses';
        },

        openAddModal() {
            this.isEditing = false;
            this.editingId = null;
            this.resetForm();
            this.showModal = true;
        },

        async openEditModal(addressId) {
            this.isEditing = true;
            this.editingId = addressId;

            try {
                const response = await fetch(`/account/addresses/${addressId}/json`);
                if (response.ok) {
                    const data = await response.json();
                    this.form = {
                        label: data.label || '',
                        full_name: data.full_name || '',
                        company: data.company || '',
                        address_line1: data.address_line1 || '',
                        address_line2: data.address_line2 || '',
                        city: data.city || '',
                        state: data.state || '',
                        postal_code: data.postal_code || '',
                        country: data.country || 'US',
                        phone: data.phone || '',
                        is_default_shipping: false
                    };
                }
            } catch (e) {
                console.error('Failed to load address:', e);
            }

            this.showModal = true;
        },

        closeModal() {
            this.showModal = false;
            this.resetForm();
        },

        resetForm() {
            this.form = {
                label: '',
                full_name: '',
                company: '',
                address_line1: '',
                address_line2: '',
                city: '',
                state: '',
                postal_code: '',
                country: 'US',
                phone: '',
                is_default_shipping: false
            };
        }
    };
}
</script>
{{end}}
