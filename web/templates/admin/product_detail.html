{{define "title"}}{{.Product.Name}} - Product Details{{end}}

{{define "content"}}
<div class="space-y-8">
    <!-- Back Link -->
    <div>
        <a href="/admin/products"
           class="inline-flex items-center gap-2 text-sm/6 text-zinc-500 hover:text-zinc-950 dark:text-zinc-400 dark:hover:text-white">
            ← Back to Products
        </a>
    </div>

    <!-- Page Header with Actions -->
    <div class="flex items-start justify-between">
        <div>
            {{template "heading" (dict "Level" "2" "Content" .Product.Name)}}
            <div class="mt-2 flex items-center gap-3">
                {{if eq .Product.Status "active"}}
                    {{template "badge" (dict "Content" "Active" "Color" "green")}}
                {{else if eq .Product.Status "draft"}}
                    {{template "badge" (dict "Content" "Draft" "Color" "zinc")}}
                {{else}}
                    {{template "badge" (dict "Content" .Product.Status "Color" "red")}}
                {{end}}

                <span class="text-sm text-zinc-500 dark:text-zinc-400">
                    Visibility: {{.Product.Visibility}}
                </span>

                {{if .Product.Origin.Valid}}
                <span class="text-sm text-zinc-500 dark:text-zinc-400">
                    • {{.Product.Origin.String}}
                </span>
                {{end}}
            </div>
        </div>

        <div class="flex gap-3">
            {{template "button" (dict
                "Content" "View in Store →"
                "Variant" "outline"
                "Href" (printf "/products/%s" .Product.Slug)
                "Class" "target-blank")}}

            {{template "button" (dict
                "Content" "Edit Product"
                "Variant" "solid"
                "Color" "zinc"
                "Href" (printf "/admin/products/%s/edit" .Product.ID))}}
        </div>
    </div>

    <!-- Short Description -->
    {{if .Product.ShortDescription.Valid}}
    <div class="rounded-xl bg-zinc-50 p-4 ring-1 ring-zinc-950/5 dark:bg-zinc-900/50 dark:ring-white/10">
        <p class="text-base/7 text-zinc-700 dark:text-zinc-300">
            {{.Product.ShortDescription.String}}
        </p>
    </div>
    {{end}}

    <!-- Product Images Section -->
    <section class="rounded-2xl bg-white ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <div class="border-b border-zinc-950/5 px-6 py-4 dark:border-white/5">
            {{template "heading" (dict "Level" "3" "Content" "Product Images")}}
            <p class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">
                Upload photos of your coffee product (max 5MB, JPG/PNG/WebP)
            </p>
        </div>

        <!-- Upload Form -->
        <div class="border-b border-zinc-950/5 px-6 py-4 dark:border-white/5">
            <form
                x-data="imageUploader()"
                hx-post="/admin/products/{{.Product.ID}}/images/upload"
                hx-target="#image-gallery"
                hx-swap="innerHTML"
                hx-encoding="multipart/form-data"
                @htmx:xhr:progress="uploading = true"
                @htmx:after-request="resetUploader()"
                class="space-y-4">

                <!-- CSRF Token -->
                <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

                <!-- Drop Zone -->
                <div
                    @dragover.prevent="dragover = true"
                    @dragleave.prevent="dragover = false"
                    @drop.prevent="handleDrop($event)"
                    @click="$refs.fileInput.click()"
                    :class="dragover ? 'border-teal-700 bg-teal-50 dark:bg-teal-950/20' : 'border-zinc-300 dark:border-zinc-700'"
                    class="relative cursor-pointer rounded-lg border-2 border-dashed bg-zinc-50/50 px-6 py-8 text-center transition-colors hover:border-zinc-400 dark:bg-zinc-800/50 dark:hover:border-zinc-600">

                    <!-- Hidden file input -->
                    <input
                        type="file"
                        id="image-file"
                        name="image"
                        accept="image/jpeg,image/png,image/webp"
                        x-ref="fileInput"
                        @change="handleFileSelect($event)"
                        class="sr-only">

                    <!-- Upload icon and text (shown when no file selected) -->
                    <div x-show="!selectedFile" class="space-y-2">
                        <svg class="mx-auto h-12 w-12 text-zinc-400 dark:text-zinc-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <div class="text-sm text-zinc-600 dark:text-zinc-400">
                            <span class="font-medium text-teal-700 dark:text-teal-400">Click to upload</span>
                            or drag and drop
                        </div>
                        <p class="text-xs text-zinc-500 dark:text-zinc-500">
                            JPG, PNG, or WebP up to 5MB
                        </p>
                    </div>

                    <!-- Preview (shown when file selected) -->
                    <div x-show="selectedFile" class="space-y-3">
                        <div class="relative mx-auto h-32 w-32 overflow-hidden rounded-lg">
                            <img x-bind:src="previewUrl" alt="Preview" class="h-full w-full object-cover">
                        </div>
                        <div class="text-sm">
                            <p class="font-medium text-zinc-900 dark:text-white" x-text="selectedFile?.name"></p>
                            <p class="text-xs text-zinc-500 dark:text-zinc-400" x-text="fileSize"></p>
                        </div>
                        <button
                            type="button"
                            @click.stop="clearSelection()"
                            class="text-xs text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white">
                            Choose different file
                        </button>
                    </div>

                    <!-- Upload progress overlay -->
                    <div x-show="uploading" class="absolute inset-0 flex items-center justify-center rounded-lg bg-white/90 dark:bg-zinc-900/90">
                        <div class="text-center">
                            <svg class="mx-auto h-8 w-8 animate-spin text-teal-700 dark:text-teal-400" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                            <p class="mt-2 text-sm font-medium text-zinc-700 dark:text-zinc-300">Uploading...</p>
                        </div>
                    </div>
                </div>

                <!-- Error message -->
                <div x-show="errorMessage" class="rounded-lg bg-red-50 px-4 py-3 text-sm text-red-800 dark:bg-red-950/20 dark:text-red-400">
                    <p x-text="errorMessage"></p>
                </div>

                <!-- Upload button -->
                <div x-show="selectedFile && !uploading">
                    {{template "button" (dict
                        "Content" "Upload Image"
                        "Variant" "solid"
                        "Color" "zinc"
                        "Type" "submit"
                        "Class" "w-full")}}
                </div>
            </form>

            <script>
                function imageUploader() {
                    return {
                        selectedFile: null,
                        previewUrl: null,
                        dragover: false,
                        uploading: false,
                        errorMessage: '',

                        handleFileSelect(event) {
                            const file = event.target.files[0];
                            this.validateAndSetFile(file);
                        },

                        handleDrop(event) {
                            this.dragover = false;
                            const file = event.dataTransfer.files[0];
                            this.validateAndSetFile(file);
                        },

                        validateAndSetFile(file) {
                            this.errorMessage = '';

                            if (!file) return;

                            // Validate file type
                            const validTypes = ['image/jpeg', 'image/png', 'image/webp'];
                            if (!validTypes.includes(file.type)) {
                                this.errorMessage = 'Please select a JPG, PNG, or WebP image.';
                                return;
                            }

                            // Validate file size (5MB = 5 * 1024 * 1024 bytes)
                            const maxSize = 5 * 1024 * 1024;
                            if (file.size > maxSize) {
                                this.errorMessage = 'Image must be smaller than 5MB. This file is ' + this.formatFileSize(file.size) + '.';
                                return;
                            }

                            // Set file and create preview
                            this.selectedFile = file;
                            this.previewUrl = URL.createObjectURL(file);

                            // Update the hidden file input
                            const dataTransfer = new DataTransfer();
                            dataTransfer.items.add(file);
                            this.$refs.fileInput.files = dataTransfer.files;
                        },

                        clearSelection() {
                            this.selectedFile = null;
                            this.previewUrl = null;
                            this.errorMessage = '';
                            this.$refs.fileInput.value = '';
                            if (this.previewUrl) {
                                URL.revokeObjectURL(this.previewUrl);
                            }
                        },

                        resetUploader() {
                            this.clearSelection();
                            this.uploading = false;
                        },

                        formatFileSize(bytes) {
                            if (bytes < 1024) return bytes + ' bytes';
                            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                            return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
                        },

                        get fileSize() {
                            return this.selectedFile ? this.formatFileSize(this.selectedFile.size) : '';
                        }
                    }
                }
            </script>
        </div>

        <!-- Image Gallery -->
        <div id="image-gallery" class="p-6">
            {{if .Images}}
                <div class="grid grid-cols-2 gap-4 sm:grid-cols-3 lg:grid-cols-4">
                    {{range .Images}}
                    <div class="group relative flex flex-col overflow-hidden rounded-lg border border-zinc-200 bg-white dark:border-zinc-700 dark:bg-zinc-800">
                        <!-- Image container -->
                        <div class="relative aspect-square">
                            <img src="{{.Url}}" alt="{{if .AltText.Valid}}{{.AltText.String}}{{end}}" class="h-full w-full object-cover">

                            {{if .IsPrimary}}
                            <div class="absolute right-2 top-2">
                                {{template "badge" (dict "Content" "Default" "Color" "blue")}}
                            </div>
                            {{end}}

                            <!-- Actions overlay on hover -->
                            <div class="absolute inset-0 flex items-center justify-center gap-2 bg-black/60 opacity-0 transition-opacity group-hover:opacity-100">
                                {{if not .IsPrimary}}
                                <button
                                    hx-post="/admin/products/{{$.Product.ID}}/images/{{.ID}}/default"
                                    hx-target="#image-gallery"
                                    hx-swap="innerHTML"
                                    hx-vals='{"csrf_token": "{{$.CSRFToken}}"}'
                                    class="rounded-lg bg-white px-3 py-1.5 text-xs font-medium text-zinc-900 hover:bg-zinc-100">
                                    Set Default
                                </button>
                                {{end}}

                                <button
                                    hx-delete="/admin/products/{{$.Product.ID}}/images/{{.ID}}"
                                    hx-target="#image-gallery"
                                    hx-swap="innerHTML"
                                    hx-confirm="Delete this image?"
                                    hx-vals='{"csrf_token": "{{$.CSRFToken}}"}'
                                    class="rounded-lg bg-red-600 px-3 py-1.5 text-xs font-medium text-white hover:bg-red-700">
                                    Delete
                                </button>
                            </div>
                        </div>

                        <!-- Image info and alt text form -->
                        <div class="flex flex-col gap-2 border-t border-zinc-200 p-3 dark:border-zinc-700">
                            <!-- Dimensions display -->
                            {{if and .Width.Valid .Height.Valid}}
                            <p class="text-xs text-zinc-500 dark:text-zinc-400">
                                {{.Width.Int32}} × {{.Height.Int32}} px
                            </p>
                            {{end}}

                            <!-- Alt text form -->
                            <form
                                x-data="{ saved: false }"
                                hx-post="/admin/products/{{$.Product.ID}}/images/{{.ID}}/metadata"
                                hx-swap="none"
                                @htmx:after-request="saved = true; setTimeout(() => saved = false, 2000)"
                                class="space-y-1">
                                <input type="hidden" name="csrf_token" value="{{$.CSRFToken}}">
                                <label class="block text-xs font-medium text-zinc-600 dark:text-zinc-400">Alt text</label>
                                <div class="flex gap-2">
                                    <input
                                        type="text"
                                        name="alt_text"
                                        value="{{if .AltText.Valid}}{{.AltText.String}}{{end}}"
                                        placeholder="Describe the image"
                                        class="flex-1 rounded-md border border-zinc-300 bg-white px-2 py-1 text-xs text-zinc-900 placeholder:text-zinc-400 dark:border-zinc-600 dark:bg-zinc-800 dark:text-white dark:placeholder:text-zinc-500">
                                    <button
                                        type="submit"
                                        class="rounded-lg px-3 py-1.5 text-xs font-semibold transition-colors"
                                        :class="saved ? 'bg-green-600 text-white' : 'bg-zinc-900 text-white hover:bg-zinc-800 dark:bg-white dark:text-zinc-900 dark:hover:bg-zinc-100'">
                                        <span x-show="!saved">Save</span>
                                        <span x-show="saved" x-cloak>Saved!</span>
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                    {{end}}
                </div>
            {{else}}
                <p class="text-sm text-zinc-500 dark:text-zinc-400">No images yet. Upload your first product image above.</p>
            {{end}}
        </div>
    </section>

    <!-- SKUs Section -->
    <section class="rounded-2xl bg-white ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
        <div class="flex items-center justify-between border-b border-zinc-950/5 px-6 py-4 dark:border-white/5">
            <div>
                {{template "heading" (dict "Level" "3" "Content" "Product Variants (SKUs)")}}
                <p class="mt-1 text-sm/6 text-zinc-600 dark:text-zinc-400">
                    Sizes and grind options available for this coffee
                </p>
            </div>

            {{template "button" (dict
                "Content" "Add SKU"
                "Variant" "solid"
                "Color" "zinc"
                "Size" "sm"
                "Href" (printf "/admin/products/%s/skus/new" .Product.ID))}}
        </div>

        {{if .SKUs}}
        <div class="overflow-x-auto">
            <table class="min-w-full text-left text-sm/6 text-zinc-950 dark:text-white">
                <thead class="text-zinc-500 dark:text-zinc-400">
                    <tr>
                        <th class="px-6 py-3 font-medium">SKU</th>
                        <th class="px-6 py-3 font-medium">Weight</th>
                        <th class="px-6 py-3 font-medium">Grind</th>
                        <th class="px-6 py-3 font-medium text-right">Base Price</th>
                        <th class="px-6 py-3 font-medium">Stock</th>
                        <th class="px-6 py-3 font-medium">
                            <span class="sr-only">Actions</span>
                        </th>
                    </tr>
                </thead>
                <tbody class="divide-y divide-zinc-950/5 dark:divide-white/5">
                    {{range .SKUs}}
                    <tr class="hover:bg-zinc-950/[2.5%] dark:hover:bg-white/[2.5%]">
                        <td class="px-6 py-4 font-mono text-sm">{{.Sku}}</td>
                        <td class="px-6 py-4">
                            {{.WeightValueFormatted}} {{.WeightUnit}}
                        </td>
                        <td class="px-6 py-4 capitalize">{{.GrindType}}</td>
                        <td class="px-6 py-4 text-right font-medium">
                            ${{.BasePriceDollars}}
                        </td>
                        <td class="px-6 py-4">
                            {{if .TrackInventory}}
                                {{if le .StockQuantity 0}}
                                    {{template "badge" (dict "Content" "Out of Stock" "Color" "red")}}
                                {{else if le .StockQuantity 5}}
                                    {{template "badge" (dict "Content" (printf "%d in stock" .StockQuantity) "Color" "amber")}}
                                {{else}}
                                    {{template "badge" (dict "Content" (printf "%d in stock" .StockQuantity) "Color" "green")}}
                                {{end}}
                            {{else}}
                                <span class="text-zinc-500 dark:text-zinc-400">Not tracked</span>
                            {{end}}
                        </td>
                        <td class="px-6 py-4 text-right">
                            <a href="/admin/products/{{$.Product.ID}}/skus/{{.SkuID}}/edit"
                               class="text-sm/6 font-medium text-zinc-950 hover:text-zinc-700 dark:text-white dark:hover:text-zinc-300">
                                Edit
                            </a>
                        </td>
                    </tr>
                    {{end}}
                </tbody>
            </table>
        </div>
        {{else}}
        <div class="p-8">
            {{template "empty-state" (dict
                "Title" "No SKUs yet"
                "Description" "Add product variants with different sizes and grind options"
                "Action" (dict
                    "Content" "Add Your First SKU"
                    "Variant" "solid"
                    "Color" "zinc"
                    "Href" (printf "/admin/products/%s/skus/new" .Product.ID)))}}
        </div>
        {{end}}
    </section>

    <!-- Product Details Grid -->
    <div class="grid gap-8 lg:grid-cols-2">
        <!-- Coffee Attributes -->
        <section class="rounded-2xl bg-white p-6 ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
            {{template "heading" (dict "Level" "3" "Content" "Coffee Attributes")}}

            <dl class="mt-6 space-y-4">
                {{if .Product.Origin.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Origin</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white">{{.Product.Origin.String}}</dd>
                </div>
                {{end}}

                {{if .Product.Region.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Region</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white">{{.Product.Region.String}}</dd>
                </div>
                {{end}}

                {{if .Product.Producer.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Producer</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white">{{.Product.Producer.String}}</dd>
                </div>
                {{end}}

                {{if .Product.Process.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Process</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white capitalize">{{.Product.Process.String}}</dd>
                </div>
                {{end}}

                {{if .Product.RoastLevel.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Roast Level</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white capitalize">{{.Product.RoastLevel.String}}</dd>
                </div>
                {{end}}

                {{if or .Product.ElevationMin.Valid .Product.ElevationMax.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Elevation</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white">
                        {{if .Product.ElevationMin.Valid}}{{.Product.ElevationMin.Int32}}{{end}}
                        {{if and .Product.ElevationMin.Valid .Product.ElevationMax.Valid}}-{{end}}
                        {{if .Product.ElevationMax.Valid}}{{.Product.ElevationMax.Int32}}{{end}}
                        meters
                    </dd>
                </div>
                {{end}}

                {{if .Product.TastingNotes}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Tasting Notes</dt>
                    <dd class="mt-2 flex flex-wrap gap-2">
                        {{range .Product.TastingNotes}}
                            {{template "badge" (dict "Content" . "Color" "blue")}}
                        {{end}}
                    </dd>
                </div>
                {{end}}
            </dl>
        </section>

        <!-- Description & Metadata -->
        <section class="rounded-2xl bg-white p-6 ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10">
            {{template "heading" (dict "Level" "3" "Content" "Description & Metadata")}}

            <dl class="mt-6 space-y-4">
                {{if .Product.Description.Valid}}
                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Full Description</dt>
                    <dd class="mt-1 text-base text-zinc-700 dark:text-zinc-300 whitespace-pre-wrap">
                        {{.Product.Description.String}}
                    </dd>
                </div>
                {{end}}

                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Slug</dt>
                    <dd class="mt-1 font-mono text-sm text-zinc-700 dark:text-zinc-300">
                        {{.Product.Slug}}
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Sort Order</dt>
                    <dd class="mt-1 text-base text-zinc-950 dark:text-white">
                        {{.Product.SortOrder}}
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Created</dt>
                    <dd class="mt-1 text-base text-zinc-700 dark:text-zinc-300">
                        {{if .Product.CreatedAt.Valid}}
                            {{.Product.CreatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}
                        {{else}}
                            -
                        {{end}}
                    </dd>
                </div>

                <div>
                    <dt class="text-sm font-medium text-zinc-500 dark:text-zinc-400">Last Updated</dt>
                    <dd class="mt-1 text-base text-zinc-700 dark:text-zinc-300">
                        {{if .Product.UpdatedAt.Valid}}
                            {{.Product.UpdatedAt.Time.Format "January 2, 2006 at 3:04 PM"}}
                        {{else}}
                            -
                        {{end}}
                    </dd>
                </div>
            </dl>
        </section>
    </div>
</div>
{{end}}
