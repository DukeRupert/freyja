{{define "title"}}{{.Product.Name}}{{end}}

{{define "content"}}
<div class="mx-auto max-w-7xl">
    <!-- Breadcrumb -->
    <nav class="mb-8 flex" aria-label="Breadcrumb">
        <ol class="inline-flex items-center space-x-1 md:space-x-3">
            <li class="inline-flex items-center">
                <a href="/products" class="text-sm font-medium text-neutral-600 hover:text-teal-700 transition-colors">
                    Products
                </a>
            </li>
            <li>
                <div class="flex items-center">
                    <span class="mx-2 text-neutral-400">/</span>
                    <span class="text-sm font-medium text-neutral-900">{{.Product.Name}}</span>
                </div>
            </li>
        </ol>
    </nav>

    <div class="grid gap-8 lg:grid-cols-2">
        <!-- Product Image -->
        <div class="rounded-lg bg-neutral-100 aspect-square flex items-center justify-center border border-neutral-200">
            {{if .Images}}
                <img src="{{index .Images 0}}" alt="{{.Product.Name}}" class="h-full w-full object-cover rounded-lg">
            {{else}}
                <div class="text-center">
                    <svg class="mx-auto h-24 w-24 text-neutral-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <p class="mt-2 text-sm text-neutral-500">No image available</p>
                </div>
            {{end}}
        </div>

        <!-- Product Info -->
        <div class="flex flex-col">
            <!-- Product Name & Origin -->
            <div>
                {{template "sf-heading" (dict "Level" "1" "Content" .Product.Name)}}
                {{if .Product.Origin.Valid}}
                <p class="mt-2 text-lg text-neutral-600">{{.Product.Origin.String}}</p>
                {{end}}
            </div>

            <!-- Short Description -->
            {{if .Product.ShortDescription.Valid}}
            <p class="mt-4 text-base leading-7 text-neutral-700">
                {{.Product.ShortDescription.String}}
            </p>
            {{end}}

            <!-- SKU Selection Form -->
            <form id="add-to-cart-form" action="/cart/add" method="POST"
                  class="mt-8 space-y-6"
                  x-data="{
                      selectedWeight: '{{if .Weights}}{{index .Weights 0}}{{end}}',
                      selectedGrind: '{{if .Grinds}}{{index .Grinds 0}}{{end}}',
                      selectedSKU: null,
                      price: 0,
                      quantity: 1,
                      skus: [
                          {{range $i, $sku := .SKUs}}{{if $i}},{{end}}{
                              'id': '{{$sku.SKU.ID}}',
                              'weight': '{{formatWeight $sku.SKU.WeightValue}}{{$sku.SKU.WeightUnit}}',
                              'grind': '{{$sku.SKU.Grind}}',
                              'price': {{$sku.PriceCents}}
                          }{{end}}
                      ],
                      findMatchingSKU() {
                          const match = this.skus.find(s =>
                              s.weight === this.selectedWeight && s.grind === this.selectedGrind
                          );
                          if (match) {
                              this.selectedSKU = match.id;
                              this.price = match.price / 100;
                          }
                      }
                  }"
                  x-init="findMatchingSKU()"
                  @change="findMatchingSKU()">

                <!-- Weight Selection -->
                {{if .Weights}}
                <div>
                    {{template "field" (dict
                        "Label" "Size"
                        "Required" true
                        "Select" (dict
                            "ID" "weight"
                            "Name" "weight"
                            "Required" true
                            "XModel" "selectedWeight"
                            "Options" (list)))}}
                    <select id="weight" name="weight" required x-model="selectedWeight"
                            class="block w-full rounded-md border-neutral-300 shadow-sm focus:border-teal-700 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2 px-3 text-sm">
                        {{range .Weights}}
                        <option value="{{.}}">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <!-- Grind Selection -->
                {{if .Grinds}}
                <div>
                    {{template "field" (dict
                        "Label" "Grind"
                        "Required" true
                        "Select" (dict
                            "ID" "grind"
                            "Name" "grind"
                            "Required" true
                            "XModel" "selectedGrind"
                            "Options" (list)))}}
                    <select id="grind" name="grind" required x-model="selectedGrind"
                            class="block w-full rounded-md border-neutral-300 shadow-sm focus:border-teal-700 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2 px-3 text-sm capitalize">
                        {{range .Grinds}}
                        <option value="{{.}}" class="capitalize">{{.}}</option>
                        {{end}}
                    </select>
                </div>
                {{end}}

                <!-- Quantity -->
                <div>
                    {{template "field" (dict
                        "Label" "Quantity"
                        "Required" true
                        "Input" (dict
                            "Type" "number"
                            "ID" "quantity"
                            "Name" "quantity"
                            "Required" true
                            "Value" 1
                            "Min" 1
                            "XModel" "quantity"))}}
                    <input type="number" id="quantity" name="quantity" required x-model="quantity" min="1" value="1"
                           class="block w-full rounded-md border-neutral-300 shadow-sm focus:border-teal-700 focus:ring focus:ring-teal-200 focus:ring-opacity-50 py-2 px-3 text-sm">
                </div>

                <!-- Hidden SKU ID -->
                <input type="hidden" name="sku_id" x-model="selectedSKU">

                <!-- Price Display -->
                <div class="rounded-lg bg-neutral-50 p-4 border border-neutral-200">
                    <div class="flex items-baseline justify-between">
                        <span class="text-sm font-medium text-neutral-600">Price</span>
                        <span class="text-3xl font-bold text-neutral-900" x-text="'$' + price.toFixed(2)">$0.00</span>
                    </div>
                    <div class="mt-2 flex items-baseline justify-between text-sm">
                        <span class="text-neutral-600">Total</span>
                        <span class="font-semibold text-neutral-900" x-text="'$' + (price * quantity).toFixed(2)">$0.00</span>
                    </div>
                </div>

                <!-- Add to Cart Button -->
                <button type="submit" class="w-full inline-flex items-center justify-center gap-2 px-4 py-3 rounded-md font-medium bg-teal-700 text-white hover:bg-teal-800 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-teal-700 shadow-sm transition-colors">
                    Add to Cart
                </button>
            </form>

            <!-- Coffee Attributes -->
            {{if or .Product.RoastLevel.Valid .Product.Process.Valid .Product.TastingNotes}}
            <div class="mt-12 space-y-6">
                <h3 class="text-lg font-semibold text-neutral-900">Details</h3>

                <dl class="space-y-4">
                    {{if .Product.RoastLevel.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-neutral-600">Roast Level</dt>
                        <dd class="text-sm text-neutral-900 capitalize">{{.Product.RoastLevel.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Process.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-neutral-600">Process</dt>
                        <dd class="text-sm text-neutral-900 capitalize">{{.Product.Process.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Region.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-neutral-600">Region</dt>
                        <dd class="text-sm text-neutral-900">{{.Product.Region.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.Producer.Valid}}
                    <div class="flex justify-between">
                        <dt class="text-sm font-medium text-neutral-600">Producer</dt>
                        <dd class="text-sm text-neutral-900">{{.Product.Producer.String}}</dd>
                    </div>
                    {{end}}

                    {{if .Product.TastingNotes}}
                    <div>
                        <dt class="text-sm font-medium text-neutral-600 mb-2">Tasting Notes</dt>
                        <dd class="flex flex-wrap gap-2">
                            {{range .Product.TastingNotes}}
                                {{template "sf-badge" (dict "Content" . "Color" "amber")}}
                            {{end}}
                        </dd>
                    </div>
                    {{end}}
                </dl>
            </div>
            {{end}}

            <!-- Full Description -->
            {{if .Product.Description.Valid}}
            <div class="mt-12">
                <h3 class="text-lg font-semibold text-neutral-900 mb-4">About This Coffee</h3>
                <div class="prose max-w-none">
                    <p class="text-base leading-7 text-neutral-700 whitespace-pre-wrap">{{.Product.Description.String}}</p>
                </div>
            </div>
            {{end}}
        </div>
    </div>
</div>

<script>
// Handle form submission with HTMX or standard form
document.getElementById('add-to-cart-form')?.addEventListener('submit', function(e) {
    const skuId = this.querySelector('[name="sku_id"]').value;
    if (!skuId) {
        e.preventDefault();
        alert('Please select a size and grind option');
    }
});
</script>
{{end}}
