{{define "title"}}Configure {{.ProviderType | title}} Integration{{end}}

{{define "content"}}
<div class="space-y-8" x-data="integrationConfig('{{.CurrentProvider}}', '{{.ProviderType}}')">
    <!-- Back Link -->
    <div>
        <a href="/admin/settings/integrations"
           class="inline-flex items-center gap-2 text-sm font-medium text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white">
            <svg class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" />
            </svg>
            Back to Integrations
        </a>
    </div>

    <!-- Page Header -->
    {{template "page-header" (dict "Title" (printf "%s Integration" (.ProviderType | title)) "Description" (printf "Configure the provider for %s services" .ProviderType))}}

    <!-- Configuration Corruption Warning -->
    {{if .ConfigCorrupted}}
    <div class="rounded-lg bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 p-4">
        <div class="flex items-start gap-3">
            <svg class="h-5 w-5 text-red-600 dark:text-red-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
            <div>
                <h4 class="text-sm font-semibold text-red-800 dark:text-red-200">Configuration Error</h4>
                <p class="mt-1 text-sm text-red-700 dark:text-red-300">
                    The existing configuration could not be decrypted or is corrupted.
                    This may happen if the encryption key was changed.
                    Please re-enter your credentials to save a new configuration.
                </p>
            </div>
        </div>
    </div>
    {{end}}

    <!-- Configuration Form -->
    <div class="overflow-hidden rounded-2xl bg-white ring-1 ring-zinc-950/5 dark:bg-zinc-900 dark:ring-white/10 p-6">
        <form id="integration-form" method="POST" action="/admin/settings/integrations/{{.ProviderType}}"
              hx-post="/admin/settings/integrations/{{.ProviderType}}"
              hx-swap="outerHTML"
              class="space-y-6">
            <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

            <!-- Provider Selection -->
            <div>
                {{template "field" (dict
                    "Label" "Provider"
                    "Description" "Select the provider you want to use"
                    "Required" true
                    "Select" (dict
                        "Name" "provider_name"
                        "ID" "provider_name"
                        "Value" .CurrentProvider
                        "Required" true
                        "Options" .ProviderOptions
                        "XModel" "selectedProvider"))}}
            </div>

            <!-- Info Messages for Special Cases -->
            <div x-show="selectedProvider === 'stripe_tax'" x-cloak>
                <div class="rounded-lg bg-blue-50 dark:bg-blue-900/20 p-4 text-sm text-blue-700 dark:text-blue-400">
                    <p><strong>Note:</strong> Stripe Tax uses your billing Stripe API credentials. No additional configuration needed.</p>
                </div>
            </div>

            <div x-show="selectedProvider === 'none' || selectedProvider === 'percentage'" x-cloak>
                <div class="rounded-lg bg-zinc-50 dark:bg-zinc-900/50 p-4 text-sm text-zinc-600 dark:text-zinc-400">
                    {{if eq .ProviderType "tax"}}
                    <p><strong>Note:</strong>
                        {{if eq .CurrentProvider "none"}}No tax calculation will be applied.{{end}}
                        {{if eq .CurrentProvider "percentage"}}Tax rates are configured separately in the Tax Rates settings.{{end}}
                    </p>
                    {{end}}
                </div>
            </div>

            <div x-show="selectedProvider === 'flat_rate'" x-cloak>
                <div class="rounded-lg bg-zinc-50 dark:bg-zinc-900/50 p-4 text-sm text-zinc-600 dark:text-zinc-400">
                    <p><strong>Note:</strong> Configure flat shipping rates in the Shipping Rates settings.</p>
                </div>
            </div>

            <!-- Coming Soon Notice -->
            <div x-show="isComingSoon()" x-cloak>
                <div class="rounded-lg bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 p-4">
                    <div class="flex items-start gap-3">
                        <svg class="h-5 w-5 text-amber-600 dark:text-amber-400 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                        </svg>
                        <div>
                            <h4 class="text-sm font-semibold text-amber-800 dark:text-amber-200">Coming Soon</h4>
                            <p class="mt-1 text-sm text-amber-700 dark:text-amber-300">
                                This provider integration is not yet available. Please select a different provider or check back later.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dynamic Provider Fields -->
            <div x-show="getFields().length > 0 && !isComingSoon()" x-cloak>
                <div class="space-y-4 rounded-lg border border-zinc-200 dark:border-zinc-700 p-4">
                    <h4 class="text-sm font-semibold text-zinc-900 dark:text-white">Provider Credentials</h4>

                    <template x-for="field in getFields()" :key="field.name">
                        <div>
                            <label :for="field.name"
                                   class="block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1">
                                <span x-text="field.label"></span>
                                <span x-show="field.required" class="text-red-600 dark:text-red-500">*</span>
                            </label>
                            <input :type="field.type"
                                   :name="field.name"
                                   :id="field.name"
                                   :placeholder="field.placeholder"
                                   :required="field.required"
                                   x-model="fieldValues[field.name]"
                                   class="relative block w-full appearance-none rounded-lg border px-[calc(theme(spacing.3.5)-1px)] py-[calc(theme(spacing.2.5)-1px)] sm:px-[calc(theme(spacing.3)-1px)] sm:py-[calc(theme(spacing.1.5)-1px)] text-base/6 text-zinc-950 placeholder:text-zinc-500 sm:text-sm/6 border-zinc-950/10 hover:border-zinc-950/20 dark:border-white/10 dark:hover:border-white/20 focus:outline focus:outline-2 focus:-outline-offset-1 focus:outline-blue-500 dark:text-white dark:placeholder:text-zinc-500 bg-transparent dark:bg-zinc-800">
                        </div>
                    </template>
                </div>
            </div>

            <!-- Test Connection Status -->
            <div x-show="testStatus !== null" x-cloak class="rounded-lg p-4"
                 :class="testStatus === 'success'
                    ? 'bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800'
                    : 'bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800'">
                <div class="flex items-center gap-3">
                    <!-- Success Icon -->
                    <svg x-show="testStatus === 'success'" class="h-5 w-5 text-green-600 dark:text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                    </svg>
                    <!-- Error Icon -->
                    <svg x-show="testStatus === 'error'" class="h-5 w-5 text-red-600 dark:text-red-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                    </svg>
                    <span class="text-sm font-medium"
                          :class="testStatus === 'success'
                            ? 'text-green-800 dark:text-green-200'
                            : 'text-red-800 dark:text-red-200'"
                          x-text="testMessage"></span>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex items-center gap-4 pt-4 border-t border-zinc-200 dark:border-zinc-700">
                <!-- Test Connection Button (if provider has fields and is implemented) -->
                <button type="button"
                        x-show="getFields().length > 0 && !isComingSoon()"
                        :disabled="testLoading"
                        @click="testConnection()"
                        :class="testLoading ? 'opacity-50 cursor-wait' : ''"
                        class="rounded-lg border border-zinc-950/10 text-zinc-950 bg-transparent px-[calc(theme(spacing.3.5)-1px)] py-[calc(theme(spacing.2.5)-1px)] sm:px-[calc(theme(spacing.3)-1px)] sm:py-[calc(theme(spacing.1.5)-1px)] sm:text-sm/6 text-base/6 font-semibold hover:border-zinc-950/20 hover:bg-zinc-950/[2.5%] dark:border-white/15 dark:text-white dark:hover:border-white/25 dark:hover:bg-white/5">
                    <span x-show="!testLoading">Test Connection</span>
                    <span x-show="testLoading" class="flex items-center gap-2">
                        <svg class="animate-spin h-4 w-4" fill="none" viewBox="0 0 24 24">
                            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                        </svg>
                        Testing...
                    </span>
                </button>

                <!-- Save Button -->
                <button type="submit"
                        :disabled="!isFormValid()"
                        :class="isFormValid()
                            ? 'bg-zinc-900 text-white hover:bg-zinc-800 dark:bg-white dark:text-zinc-900 dark:hover:bg-zinc-100'
                            : 'bg-zinc-300 text-zinc-500 cursor-not-allowed dark:bg-zinc-700 dark:text-zinc-400'"
                        class="rounded-lg border border-transparent px-[calc(theme(spacing.3.5)-1px)] py-[calc(theme(spacing.2.5)-1px)] sm:px-[calc(theme(spacing.3)-1px)] sm:py-[calc(theme(spacing.1.5)-1px)] sm:text-sm/6 text-base/6 font-semibold">
                    Save Configuration
                </button>

                <!-- Cancel Link -->
                <a href="/admin/settings/integrations"
                   class="text-sm font-medium text-zinc-600 hover:text-zinc-900 dark:text-zinc-400 dark:hover:text-white">
                    Cancel
                </a>
            </div>
        </form>
    </div>

    <!-- Help Text -->
    <div class="rounded-lg bg-zinc-50 dark:bg-zinc-900/50 p-4 text-sm text-zinc-600 dark:text-zinc-400">
        <p><strong>Security:</strong> API credentials are encrypted before being stored in the database. Existing credentials are masked in the form for security.</p>

        {{if eq .ProviderType "billing"}}
        <p class="mt-2"><strong>Webhook URL:</strong> Configure webhooks in your Stripe dashboard to point to: <code class="px-1 py-0.5 bg-zinc-100 dark:bg-zinc-800 rounded">https://yourdomain.com/webhooks/stripe</code></p>
        {{end}}

        {{if eq .ProviderType "tax"}}
        <p class="mt-2"><strong>Tax Nexus:</strong> Some providers require you to configure tax nexus (where you collect tax) in their dashboard before using their API.</p>
        {{end}}
    </div>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }
</style>

<script>
document.addEventListener('alpine:init', () => {
    Alpine.data('integrationConfig', (currentProvider, providerType) => ({
        selectedProvider: currentProvider,
        fieldValues: {},
        testStatus: null,
        testMessage: '',
        testLoading: false,
        providerType: providerType,

        // Providers that are not yet implemented
        comingSoonProviders: ['taxjar', 'avalara', 'shipstation', 'shippo', 'flat_rate', 'resend', 'ses'],

        providerFields: {
            // Tax providers
            'none': [],
            'percentage': [],
            'stripe_tax': [],
            'taxjar': [
                {name: 'taxjar_api_key', label: 'TaxJar API Key', type: 'password', placeholder: 'Enter your TaxJar API key', required: true}
            ],
            'avalara': [
                {name: 'avalara_account_id', label: 'Account ID', type: 'text', placeholder: 'Enter your Avalara account ID', required: true},
                {name: 'avalara_license_key', label: 'License Key', type: 'password', placeholder: 'Enter your Avalara license key', required: true}
            ],

            // Shipping providers
            'flat_rate': [],
            'easypost': [
                {name: 'easypost_api_key', label: 'EasyPost API Key', type: 'password', placeholder: 'Enter your EasyPost API key', required: true}
            ],
            'shipstation': [
                {name: 'shipstation_api_key', label: 'API Key', type: 'password', placeholder: 'Enter your ShipStation API key', required: true},
                {name: 'shipstation_api_secret', label: 'API Secret', type: 'password', placeholder: 'Enter your ShipStation API secret', required: true}
            ],
            'shippo': [
                {name: 'shippo_api_key', label: 'Shippo API Key', type: 'password', placeholder: 'Enter your Shippo API key', required: true}
            ],

            // Billing providers
            'stripe': [
                {name: 'stripe_publishable_key', label: 'Publishable Key', type: 'text', placeholder: 'pk_live_...', required: true},
                {name: 'stripe_api_key', label: 'Secret Key', type: 'password', placeholder: 'sk_live_...', required: true},
                {name: 'stripe_webhook_secret', label: 'Webhook Secret', type: 'password', placeholder: 'whsec_...', required: true}
            ],

            // Email providers
            'smtp': [
                {name: 'smtp_host', label: 'SMTP Host', type: 'text', placeholder: 'smtp.example.com', required: true},
                {name: 'smtp_port', label: 'SMTP Port', type: 'number', placeholder: '587', required: true},
                {name: 'smtp_username', label: 'Username', type: 'text', placeholder: 'your-username', required: true},
                {name: 'smtp_password', label: 'Password', type: 'password', placeholder: 'your-password', required: true},
                {name: 'smtp_from_name', label: 'From Name', type: 'text', placeholder: 'Acme Coffee', required: true},
                {name: 'smtp_from', label: 'From Email', type: 'email', placeholder: 'noreply@example.com', required: true}
            ],
            'postmark': [
                {name: 'postmark_api_key', label: 'Postmark Server API Token', type: 'password', placeholder: 'Enter your Postmark API token', required: true},
                {name: 'postmark_from_name', label: 'From Name', type: 'text', placeholder: 'Acme Coffee', required: true},
                {name: 'postmark_from', label: 'From Email', type: 'email', placeholder: 'noreply@example.com', required: true}
            ],
            'resend': [
                {name: 'resend_api_key', label: 'Resend API Key', type: 'password', placeholder: 're_...', required: true},
                {name: 'resend_from_name', label: 'From Name', type: 'text', placeholder: 'Acme Coffee', required: true},
                {name: 'resend_from', label: 'From Email', type: 'email', placeholder: 'noreply@example.com', required: true}
            ],
            'ses': [
                {name: 'ses_access_key_id', label: 'AWS Access Key ID', type: 'text', placeholder: 'AKIA...', required: true},
                {name: 'ses_secret_access_key', label: 'AWS Secret Access Key', type: 'password', placeholder: 'Enter your AWS secret key', required: true},
                {name: 'ses_region', label: 'AWS Region', type: 'text', placeholder: 'us-east-1', required: true},
                {name: 'ses_from_name', label: 'From Name', type: 'text', placeholder: 'Acme Coffee', required: true},
                {name: 'ses_from', label: 'From Email', type: 'email', placeholder: 'noreply@example.com', required: true}
            ]
        },

        isComingSoon() {
            return this.comingSoonProviders.includes(this.selectedProvider);
        },

        getFields() {
            return this.providerFields[this.selectedProvider] || [];
        },

        isFormValid() {
            if (this.isComingSoon()) return false;
            const fields = this.getFields();
            if (fields.length === 0) return true;
            return fields.every(field => !field.required || (this.fieldValues[field.name] && this.fieldValues[field.name].trim() !== ''));
        },

        async testConnection() {
            this.testLoading = true;
            this.testStatus = null;

            const form = document.getElementById('integration-form');
            if (!form) {
                this.testStatus = 'error';
                this.testMessage = 'Form not found';
                this.testLoading = false;
                return;
            }

            const formData = new FormData(form);
            const providerSelect = form.querySelector('select[name=provider_name]');
            if (providerSelect) {
                formData.set('provider_name', providerSelect.value);
            }

            const csrfInput = form.querySelector('input[name=csrf_token]');
            const csrfToken = csrfInput ? csrfInput.value : '';

            try {
                const response = await fetch('/admin/settings/integrations/' + this.providerType + '/test', {
                    method: 'POST',
                    headers: { 'X-CSRF-Token': csrfToken },
                    body: formData
                });

                if (!response.ok && response.status === 403) {
                    throw new Error('Session expired. Please refresh the page.');
                }

                const data = await response.json();
                this.testStatus = data.success ? 'success' : 'error';
                this.testMessage = data.message;
            } catch (err) {
                console.error('Test connection error:', err);
                this.testStatus = 'error';
                this.testMessage = err.message || 'Connection test failed';
            } finally {
                this.testLoading = false;
            }
        }
    }));
});
</script>
{{end}}
