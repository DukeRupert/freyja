{{define "title"}}{{.Product.Name}} - Freyja Coffee{{end}}

{{define "content"}}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

  <!-- Breadcrumb Navigation -->
  <nav class="mb-6" aria-label="Breadcrumb">
    <ol class="flex items-center space-x-2 text-sm text-neutral-600">
      <li><a href="/products" class="hover:text-teal-700">Coffee</a></li>
      <li><span class="text-neutral-400">/</span></li>
      <li class="text-neutral-900">{{.Product.Name}}</li>
    </ol>
  </nav>

  <!-- Product Detail Layout -->
  <div class="lg:grid lg:grid-cols-2 lg:gap-12">

    <!-- Left Column: Image -->
    <div>
      <div class="aspect-square bg-neutral-100 rounded-lg overflow-hidden flex items-center justify-center">
        <svg class="w-32 h-32 text-neutral-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/>
        </svg>
      </div>
    </div>

    <!-- Right Column: Product Info & Purchase -->
    <div class="mt-8 lg:mt-0">

      <!-- Product Title -->
      <h1 class="text-2xl font-semibold text-neutral-900">{{.Product.Name}}</h1>

      <!-- Origin & Roast Level -->
      <div class="mt-3 flex items-center gap-3 flex-wrap">
        {{if .Product.Origin.Valid}}
        <span class="text-sm text-neutral-600">{{.Product.Origin.String}}</span>
        {{end}}

        {{if .Product.RoastLevel.Valid}}
        <span class="badge-amber">
          {{.Product.RoastLevel.String}}
        </span>
        {{end}}
      </div>

      <!-- Coffee Attributes -->
      {{if or .Product.Producer.Valid .Product.Process.Valid .Product.ElevationMin.Valid .Product.ElevationMax.Valid}}
      <div class="mt-6 space-y-3 border-t border-neutral-200 pt-6">
        {{if .Product.Producer.Valid}}
        <div class="flex justify-between text-sm">
          <span class="text-neutral-600">Producer</span>
          <span class="text-neutral-900 font-medium">{{.Product.Producer.String}}</span>
        </div>
        {{end}}

        {{if .Product.Process.Valid}}
        <div class="flex justify-between text-sm">
          <span class="text-neutral-600">Process</span>
          <span class="text-neutral-900 font-medium">{{.Product.Process.String}}</span>
        </div>
        {{end}}

        {{if or .Product.ElevationMin.Valid .Product.ElevationMax.Valid}}
        <div class="flex justify-between text-sm">
          <span class="text-neutral-600">Elevation</span>
          <span class="text-neutral-900 font-medium">
            {{if .Product.ElevationMin.Valid}}{{.Product.ElevationMin.Int32}}{{end}}{{if and .Product.ElevationMin.Valid .Product.ElevationMax.Valid}}-{{end}}{{if .Product.ElevationMax.Valid}}{{.Product.ElevationMax.Int32}}{{end}}m
          </span>
        </div>
        {{end}}
      </div>
      {{end}}

      <!-- Tasting Notes -->
      {{if .Product.TastingNotes}}
      <div class="mt-6 border-t border-neutral-200 pt-6">
        <h2 class="text-sm font-medium text-neutral-700">Tasting Notes</h2>
        <p class="mt-2 text-sm text-neutral-900">
          {{range $i, $note := .Product.TastingNotes}}{{if $i}}, {{end}}{{$note}}{{end}}
        </p>
      </div>
      {{end}}

      <!-- Description -->
      {{if .Product.Description.Valid}}
      <div class="mt-6 border-t border-neutral-200 pt-6">
        <h2 class="text-sm font-medium text-neutral-700">About</h2>
        <p class="mt-2 text-sm text-neutral-700 leading-relaxed whitespace-pre-line">
          {{.Product.Description.String}}
        </p>
      </div>
      {{end}}

      <!-- SKU Selection & Add to Cart -->
      <div class="mt-8 border-t border-neutral-200 pt-6">
        {{if .SKUs}}
        <form id="product-form" method="POST" action="/cart/add"
              hx-post="/cart/add"
              hx-target="#cart-feedback"
              hx-swap="innerHTML"
              x-data="productForm()">

          <!-- CSRF Token -->
          <input type="hidden" name="csrf_token" value="{{.CSRFToken}}">

          <!-- Hidden SKU ID field -->
          <input type="hidden" name="sku_id" x-model="selectedSKUID">

          <!-- Purchase Type Toggle -->
          <div class="mb-6">
            <div class="flex rounded-lg bg-neutral-100 p-1">
              <button type="button"
                      @click="setPurchaseType('onetime')"
                      :class="purchaseType === 'onetime' ? 'bg-white shadow text-neutral-900' : 'text-neutral-600 hover:text-neutral-900'"
                      class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors">
                One-time purchase
              </button>
              <button type="button"
                      @click="setPurchaseType('subscription')"
                      :class="purchaseType === 'subscription' ? 'bg-white shadow text-neutral-900' : 'text-neutral-600 hover:text-neutral-900'"
                      class="flex-1 px-4 py-2 text-sm font-medium rounded-md transition-colors">
                Subscribe & Save
              </button>
            </div>
          </div>

          <!-- Subscription Benefits (shown when subscription selected) -->
          <div x-show="purchaseType === 'subscription'" x-collapse class="mb-6">
            <div class="rounded-lg bg-teal-50 border border-teal-200 p-4">
              <div class="flex items-start gap-3">
                <svg class="h-5 w-5 text-teal-700 flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <div>
                  <p class="text-sm font-medium text-teal-800">Fresh coffee delivered automatically</p>
                  <ul class="mt-2 space-y-1 text-sm text-teal-700">
                    <li>Never run out of your favorite beans</li>
                    <li>Skip, pause, or cancel anytime</li>
                    <li>Manage easily from your account</li>
                  </ul>
                </div>
              </div>
            </div>
          </div>

          <!-- Size Selection -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-neutral-700 mb-3">Size</label>
            <div class="flex gap-2 flex-wrap">
              {{range .Weights}}
              <button type="button"
                      @click="selectWeight('{{.}}')"
                      :class="selectedWeight === '{{.}}' ? 'bg-teal-700 text-white border-teal-700' : 'bg-white text-neutral-900 border-neutral-300 hover:border-neutral-400'"
                      class="px-4 py-2 border-2 rounded font-medium text-sm transition-colors">
                {{.}}
              </button>
              {{end}}
            </div>
          </div>

          <!-- Grind Selection -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-neutral-700 mb-3">Grind</label>
            <div class="flex gap-2 flex-wrap">
              {{range .Grinds}}
              <button type="button"
                      @click="selectGrind('{{.}}')"
                      :class="selectedGrind === '{{.}}' ? 'bg-teal-700 text-white border-teal-700' : 'bg-white text-neutral-900 border-neutral-300 hover:border-neutral-400'"
                      class="px-4 py-2 border-2 rounded font-medium text-sm transition-colors capitalize">
                {{if eq . "whole_bean"}}Whole Bean{{else}}{{.}}{{end}}
              </button>
              {{end}}
            </div>
          </div>

          <!-- Price & Stock Display -->
          <div class="mb-6 p-4 bg-neutral-50 rounded" x-show="selectedSKU">
            <div class="flex items-center justify-between mb-2">
              <span class="text-sm text-neutral-600">Price</span>
              <span class="text-lg font-semibold text-neutral-900" x-text="formatPrice(price)"></span>
            </div>
            <p class="text-xs" :class="inventoryMessage === 'In stock' ? 'text-green-700' : 'text-amber-700'" x-text="inventoryMessage"></p>
          </div>

          <!-- Delivery Frequency (shown when subscription selected) -->
          <div x-show="purchaseType === 'subscription'" x-collapse class="mb-6">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Delivery Frequency</label>
            <select name="billing_interval" x-model="billingInterval"
                    class="w-full px-3 py-2 border border-neutral-300 rounded text-sm focus:border-teal-700 focus:ring-1 focus:ring-teal-700 focus:outline-none">
              <option value="weekly">Every week</option>
              <option value="biweekly">Every 2 weeks</option>
              <option value="monthly">Every month</option>
              <option value="6_weeks">Every 6 weeks</option>
              <option value="bimonthly">Every 2 months</option>
            </select>
          </div>

          <!-- Quantity -->
          <div class="mb-6">
            <label class="block text-sm font-medium text-neutral-700 mb-2">Quantity</label>
            <div class="flex items-center gap-3">
              <button type="button"
                      @click="decreaseQty()"
                      class="w-10 h-10 border border-neutral-300 rounded hover:bg-neutral-50 text-neutral-700">
                âˆ’
              </button>
              <input type="number"
                     name="quantity"
                     x-model="quantity"
                     min="1"
                     class="w-20 text-center px-3 py-2 border border-neutral-300 rounded text-sm">
              <button type="button"
                      @click="increaseQty()"
                      class="w-10 h-10 border border-neutral-300 rounded hover:bg-neutral-50 text-neutral-700">
                +
              </button>
            </div>
          </div>

          <!-- Add to Cart / Subscribe Button -->
          <button type="submit"
                  class="btn-primary w-full flex items-center justify-center gap-2"
                  :disabled="!selectedSKU">
            <span x-show="purchaseType === 'onetime'">Add to Cart</span>
            <span x-show="purchaseType === 'subscription'">
              <svg class="h-5 w-5 inline" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
              </svg>
              Start Subscription
            </span>
          </button>

          <!-- Login prompt for subscriptions (when not logged in) -->
          {{if not .User}}
          <p x-show="purchaseType === 'subscription'" class="text-center text-sm text-neutral-600 mt-3">
            <a href="/login?return_to={{.RequestPath}}" class="text-teal-700 hover:text-teal-800 font-medium">Log in</a> or
            <a href="/signup?return_to={{.RequestPath}}" class="text-teal-700 hover:text-teal-800 font-medium">create an account</a> to subscribe
          </p>
          {{end}}

          <!-- Feedback Area -->
          <div id="cart-feedback" class="mt-4"></div>

        </form>

        <script>
          function productForm() {
            // Build SKU lookup map
            const skuMap = {};
            {{range $sku := .SKUs -}}
            skuMap['{{if $sku.SKU.WeightValue.Valid}}{{formatWeight $sku.SKU.WeightValue}}{{$sku.SKU.WeightUnit}}{{end}}|{{$sku.SKU.Grind}}'] = {
              id: '{{$sku.SKU.ID}}',
              price: {{$sku.PriceCents}},
              inventory: '{{$sku.InventoryMessage}}'
            };
            {{- end}}

            return {
              purchaseType: 'onetime',
              billingInterval: 'monthly',
              selectedWeight: '',
              selectedGrind: '',
              selectedSKU: null,
              selectedSKUID: '',
              quantity: 1,
              price: 0,
              inventoryMessage: '',
              skuMap: skuMap,

              setPurchaseType(type) {
                this.purchaseType = type;
                const form = document.getElementById('product-form');
                if (type === 'subscription') {
                  form.action = '/subscribe/checkout';
                  form.method = 'GET';
                  // Remove htmx attributes for subscription
                  form.removeAttribute('hx-post');
                  form.removeAttribute('hx-target');
                  form.removeAttribute('hx-swap');
                } else {
                  form.action = '/cart/add';
                  form.method = 'POST';
                  // Restore htmx attributes for cart
                  form.setAttribute('hx-post', '/cart/add');
                  form.setAttribute('hx-target', '#cart-feedback');
                  form.setAttribute('hx-swap', 'innerHTML');
                }
              },

              selectWeight(weight) {
                this.selectedWeight = weight;
                this.updateSKU();
              },

              selectGrind(grind) {
                this.selectedGrind = grind;
                this.updateSKU();
              },

              updateSKU() {
                if (this.selectedWeight && this.selectedGrind) {
                  const key = this.selectedWeight + '|' + this.selectedGrind;
                  const sku = this.skuMap[key];
                  if (sku) {
                    this.selectedSKU = sku;
                    this.selectedSKUID = sku.id;
                    this.price = sku.price;
                    this.inventoryMessage = sku.inventory;
                  } else {
                    this.selectedSKU = null;
                    this.selectedSKUID = '';
                    this.price = 0;
                    this.inventoryMessage = 'Not available';
                  }
                }
              },

              formatPrice(cents) {
                return '$' + (cents / 100).toFixed(2);
              },

              increaseQty() {
                this.quantity++;
              },

              decreaseQty() {
                if (this.quantity > 1) this.quantity--;
              }
            }
          }
        </script>

        {{else}}
        <!-- No SKUs Available -->
        <div class="p-4 bg-amber-50 border border-amber-200 rounded text-sm text-amber-800">
          This product is currently unavailable.
        </div>
        {{end}}
      </div>

    </div>

  </div>

</div>
{{end}}
