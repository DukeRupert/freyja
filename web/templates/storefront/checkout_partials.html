<!-- HTMX Partial Templates for Checkout Flow -->

<!-- Address Validation Success -->
{{define "address_validation_success"}}
<div class="p-4 bg-green-50 border border-green-200 rounded-lg">
  <div class="flex gap-3">
    <svg class="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
    </svg>
    <div class="flex-1">
      <p class="text-sm font-medium text-green-900">Address validated</p>
      {{if .AddressNormalized}}
      <p class="text-xs text-green-700 mt-1">
        Address normalized to: {{.NormalizedAddress.Address1}}, {{.NormalizedAddress.City}}, {{.NormalizedAddress.State}} {{.NormalizedAddress.PostalCode}}
      </p>
      {{end}}
      <button type="button"
              onclick="document.querySelector('[x-data]').__x.$data.shippingAddressComplete = true; document.querySelector('[x-data]').__x.$data.currentStep = 3"
              class="mt-3 btn-primary">
        Continue to Shipping Method
      </button>
    </div>
  </div>
</div>
{{end}}

<!-- Address Validation Error -->
{{define "address_validation_error"}}
<div class="p-4 bg-red-50 border border-red-200 rounded-lg">
  <div class="flex gap-3">
    <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div class="flex-1">
      <p class="text-sm font-medium text-red-900">Address validation failed</p>
      <p class="text-xs text-red-700 mt-1">{{.ErrorMessage}}</p>
      <p class="text-xs text-red-700 mt-2">Please check your address and try again</p>
    </div>
  </div>
</div>
{{end}}

<!-- Shipping Rates -->
{{define "shipping_rates"}}
{{if .Rates}}
<div class="space-y-3">
  {{range .Rates}}
  <label class="flex items-center justify-between p-4 border-2 border-neutral-200 rounded-lg cursor-pointer hover:border-teal-700 transition-colors has-[:checked]:border-teal-700 has-[:checked]:bg-teal-50">
    <div class="flex items-center gap-3">
      <input type="radio"
             name="shipping_rate"
             value="{{.ID}}"
             class="w-4 h-4 text-teal-700 border-neutral-300 focus:ring-teal-700"
             onchange="selectShippingRate('{{.ID}}', {{.RateCents}}, '{{.Carrier}}', '{{.Service}}', '{{.EstimatedDays}}')">
      <div>
        <p class="text-sm font-medium text-neutral-900">{{.Carrier}} {{.Service}}</p>
        <p class="text-xs text-neutral-600">{{.EstimatedDays}} business days</p>
      </div>
    </div>
    <div class="text-sm font-medium text-neutral-900">
      ${{printf "%.2f" (divf .RateCents 100.0)}}
    </div>
  </label>
  {{end}}
</div>

<div class="mt-4">
  <button type="button"
          id="shipping-continue-btn"
          class="btn-primary"
          disabled
          onclick="document.querySelector('[x-data]').__x.$data.shippingMethodComplete = true; document.querySelector('[x-data]').__x.$data.currentStep = 4">
    Continue to Billing
  </button>
</div>

<script>
function selectShippingRate(rateId, rateCents, carrier, service, estimatedDays) {
  // Update UI with selected rate
  document.getElementById('shipping-cost').textContent = '$' + (rateCents / 100).toFixed(2);

  // Enable continue button
  document.getElementById('shipping-continue-btn').disabled = false;

  // Store selected rate in Alpine state
  const alpineData = document.querySelector('[x-data]').__x.$data;
  alpineData.selectedRate = {
    id: rateId,
    rateCents: rateCents,
    carrier: carrier,
    service: service,
    estimatedDays: estimatedDays
  };

  // Calculate total with shipping
  calculateTotalWithShipping(rateCents);
}

function calculateTotalWithShipping(shippingCents) {
  // Make htmx request to calculate total with tax
  htmx.ajax('POST', '/api/checkout/calculate-total', {
    target: '#order-total',
    swap: 'innerHTML',
    values: { shipping_cents: shippingCents }
  });
}
</script>
{{else}}
<div class="p-4 bg-amber-50 border border-amber-200 rounded-lg">
  <div class="flex gap-3">
    <svg class="w-5 h-5 text-amber-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div class="flex-1">
      <p class="text-sm font-medium text-amber-900">No shipping rates available</p>
      <p class="text-xs text-amber-700 mt-1">
        We couldn't find shipping options for this address. Please contact us for assistance.
      </p>
    </div>
  </div>
</div>
{{end}}
{{end}}

<!-- Calculate Total Response -->
{{define "order_total"}}
${{printf "%.2f" (divf .TotalCents 100.0)}}
<script>
  // Also update tax amount
  document.getElementById('tax-amount').textContent = '${{printf "%.2f" (divf .TaxCents 100.0)}}';
</script>
{{end}}

<!-- Payment Intent Created -->
{{define "payment_intent_created"}}
<div id="stripe-payment-container">
  <!-- Stripe Payment Element will mount here -->
</div>

<script>
// Initialize Stripe
const stripe = Stripe('{{.StripePublishableKey}}');

// Create Payment Element
const options = {
  clientSecret: '{{.ClientSecret}}',
  appearance: {
    theme: 'stripe',
    variables: {
      colorPrimary: '#2A7D7D',
      colorBackground: '#ffffff',
      colorText: '#1A1A1A',
      colorDanger: '#C45D4A',
      fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif',
      spacingUnit: '4px',
      borderRadius: '6px'
    }
  }
};

const elements = stripe.elements(options);
const paymentElement = elements.create('payment');
paymentElement.mount('#payment-element');

// Handle payment submission
document.getElementById('submit-payment').addEventListener('click', async () => {
  const alpineData = document.querySelector('[x-data]').__x.$data;
  alpineData.processing = true;

  const { error } = await stripe.confirmPayment({
    elements,
    confirmParams: {
      return_url: window.location.origin + '/checkout/complete',
      receipt_email: alpineData.email,
      shipping: {
        name: alpineData.shippingName,
        address: {
          line1: alpineData.shippingAddress1,
          line2: alpineData.shippingAddress2,
          city: alpineData.shippingCity,
          state: alpineData.shippingState,
          postal_code: alpineData.shippingPostalCode,
          country: 'US'
        }
      }
    }
  });

  if (error) {
    // Show error message
    const errorElement = document.getElementById('payment-error');
    errorElement.textContent = error.message;
    errorElement.classList.remove('hidden');
    alpineData.processing = false;
  }
});
</script>
{{end}}

<!-- Payment Intent Error -->
{{define "payment_intent_error"}}
<div class="p-4 bg-red-50 border border-red-200 rounded-lg">
  <div class="flex gap-3">
    <svg class="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
    </svg>
    <div class="flex-1">
      <p class="text-sm font-medium text-red-900">Payment initialization failed</p>
      <p class="text-xs text-red-700 mt-1">{{.ErrorMessage}}</p>
      <button type="button"
              onclick="htmx.trigger('#payment-intent-container', 'load')"
              class="mt-3 text-sm text-teal-700 hover:text-teal-800 font-medium">
        Try again
      </button>
    </div>
  </div>
</div>
{{end}}
